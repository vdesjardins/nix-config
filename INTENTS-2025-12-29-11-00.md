# Fix OPNsense Grafana Processes Panel - Colors and Color Shifting Issue

**Date:** 2025-12-29 (updated from previous Processes panel fix)  
**Problem:** Colors of the three query series were changing when hovering over the graph due to continuous color gradient mode

## Analysis of Color Shifting Issue

**Original Configuration:**
```nix
color = {
  mode = "continuous-GrYlRd";  # Continuous gradient: Green → Yellow → Red
};
```

**Why Colors Shifted on Hover:**
- `continuous-GrYlRd` assigns colors based on **relative values** at each point in time
- When hovering, Grafana highlights which series is highest at that moment
- Colors dynamically map to magnitude: highest value = RED, lowest = GREEN
- Result: Each series changed color as you moved the cursor across the graph

**Example Behavior:**
```
Time T1: System Calls/sec = 50,000 (highest) → displayed in RED
Time T2: Forks/sec = 100,000 (highest) → displayed in RED (changed!)
Time T3: Traps/sec = 10,000 (highest) → displayed in GREEN (changed again!)
```

**Why This Was Wrong for Firewall Monitoring:**
- ❌ Colors should identify individual metrics, not their relative magnitude
- ❌ Users can't easily track a single line across the graph
- ❌ Shifting colors are confusing and hard to follow visually
- ❌ Standard line charts use fixed colors per series

---

## Solution Implemented

Changed color mode from `continuous-GrYlRd` to `palette-classic`:

**Benefits:**
- ✅ Each series gets a **fixed, distinct color** (Blue, Red, Green, Purple, Orange, etc.)
- ✅ Colors **never change** regardless of value magnitude
- ✅ Easy to track individual metrics across the entire time range
- ✅ Intuitive behavior matching standard line chart expectations
- ✅ Hovering shows values without visual color shifts

### Changes Made

#### Updated `fixProcessesPanel` Function in `hosts/modules/linux/shared/grafana/lib/default.nix` (lines 157-163)

Added `fieldConfig` override to set color mode:

```nix
fieldConfig = panel.fieldConfig // {
  defaults = panel.fieldConfig.defaults // {
    color = {
      mode = "palette-classic";
    };
  };
};
```

## Verification

✅ Transformation tested and verified:
```
Input color mode:  "continuous-GrYlRd"
Output color mode: "palette-classic"
```

✅ Configuration built successfully

## Visual Impact

### Before
- **Color Scheme:** Green-Yellow-Red gradient based on current values
- **Behavior:** Colors shift as you hover across the graph
- **Tracking:** Hard to follow individual lines due to color changes

### After
- **Color Scheme:** Fixed palette (Blue, Red, Green, Purple, Orange, etc.)
- **Behavior:** Each series keeps its assigned color throughout
- **Tracking:** Easy to follow each line from start to end
- **Hovering:** Shows values without confusing color shifts

## Files Modified

1. `hosts/modules/linux/shared/grafana/lib/default.nix` - Updated `fixProcessesPanel` function to include color mode configuration

## Next Steps

1. Apply changes: `make host/apply`
2. Verify Processes panel now shows three series with stable, distinct colors
3. Confirm colors don't shift when hovering over the graph
4. Verify each line is easy to track across the entire time range

## Related Changes

This is an enhancement to the previous Processes panel fix that converted it from:
- Bar Gauge (cumulative counters) → Time Series (rate-based metrics)
- Multiple visual improvements (rates, better visualization)
- Now adds: Fixed color scheme for better tracking and usability

**All Processes Panel Improvements:**
1. Changed from cumulative counters to rate-based metrics (events/sec)
2. Changed visualization from bar gauge to time series
3. Fixed color mode from continuous gradient to fixed palette
