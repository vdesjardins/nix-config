#!/usr/bin/env bash
set -euo pipefail

# OpenCode Sandbox - Minimal bubblewrap-based isolated environment
# Supports YOLO mode for AI agents with flexible command execution and network isolation

# Global configuration
DISABLE_NET=0
YOLO_MODE=0
EXTRA_BINDS=()
EXTRA_RO_BINDS=()
COMMAND_ARGS=()
OPENCODE_ARGS=()
VERSION="0.1.0"

# Color output
RED='\033[0;31m'
NC='\033[0m' # No Color

##############################################################################
# Helper Functions
##############################################################################

show_help() {
  cat <<'EOF'
USAGE:
  opencode-sandbox [OPTIONS] [COMMAND...] [-- OPENCODE_ARGS...]

OPTIONS:
   --yolo                Yolo mode: skip confirmation prompts for external commands
   --no-net              Disable network access (default: network enabled)
   --bind SRC:DST        Bind mount read-write, can repeat
   --bind-ro SRC:DST     Bind mount read-only, can repeat
   --help                Show this help message
   --version             Show version

COMMAND:
    If omitted, launches opencode in an interactive shell
    Otherwise executes COMMAND with args in sandbox

OPENCODE_ARGS:
    Arguments to pass directly to opencode after '--' delimiter
    These are passed to the opencode command for additional configuration

EXAMPLES:
    # Launch opencode (default)
    opencode-sandbox

    # Run interactive shell
    opencode-sandbox zsh

    # Run a one-off command
    opencode-sandbox nix --version

    # Network-isolated mode (no network access)
    opencode-sandbox --no-net

    # Yolo mode: skip confirmation prompts
    opencode-sandbox --yolo

    # Mount extra directory
    opencode-sandbox --bind /data:/data python3 script.py

    # Nix operations in sandbox
    opencode-sandbox nix build '.#myapp'
    opencode-sandbox nix shell nixpkgs#python3 -- python3 script.py

    # Pass parameters to opencode
    opencode-sandbox -- --model claude-opus
    opencode-sandbox --yolo opencode -- --timeout 300
    opencode-sandbox nix -- --flake '.#custom'
EOF
}

show_version() {
  echo "opencode-sandbox version $VERSION"
}

error() {
  echo -e "${RED}error: $*${NC}" >&2
  exit 1
}

##############################################################################
# Argument Parsing
##############################################################################

parse_args() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
    --help)
      show_help
      exit 0
      ;;
    --version)
      show_version
      exit 0
      ;;
    --yolo)
      YOLO_MODE=1
      shift
      ;;
    --no-net)
      DISABLE_NET=1
      shift
      ;;
    --bind)
      if [[ -z "${2:-}" ]]; then
        error "--bind requires an argument (SRC:DST)"
      fi
      EXTRA_BINDS+=("$2")
      shift 2
      ;;
    --bind-ro)
      if [[ -z "${2:-}" ]]; then
        error "--bind-ro requires an argument (SRC:DST)"
      fi
      EXTRA_RO_BINDS+=("$2")
      shift 2
      ;;
    --)
      # Everything after -- is for opencode
      shift
      OPENCODE_ARGS=("$@")
      break
      ;;
    --*)
      error "unknown option: $1"
      ;;
    *)
      # Remaining args are the command, unless we hit --
      COMMAND_ARGS=("$@")
      # Check if command contains -- delimiter
      local cmd_index=0
      for arg in "${COMMAND_ARGS[@]}"; do
        if [[ "$arg" == "--" ]]; then
          # Split COMMAND_ARGS at the -- delimiter
          OPENCODE_ARGS=("${COMMAND_ARGS[@]:$((cmd_index + 1))}")
          COMMAND_ARGS=("${COMMAND_ARGS[@]:0:cmd_index}")
          break
        fi
        ((cmd_index++))
      done
      break
      ;;
    esac
  done
}

##############################################################################
# Bubblewrap Invocation
##############################################################################

run_sandbox() {
  local bwrap_args=()

   # Core filesystem access
   bwrap_args+=(--dev /dev)
   bwrap_args+=(--proc /proc)

   # Shell access for subprocess spawning (needed by pre-commit, npm, etc.)
   bwrap_args+=(--ro-bind /bin/sh /bin/sh)

   # System files for user/group resolution
   bwrap_args+=(--ro-bind /etc/passwd /etc/passwd)
   bwrap_args+=(--ro-bind /etc/group /etc/group)
   bwrap_args+=(--ro-bind /etc/hostname /etc/hostname)

   # /nix/store - writable, shared with host (agent can install packages)
   bwrap_args+=(--bind /nix/store /nix/store)
   bwrap_args+=(--ro-bind /nix/var /nix/var)

   # Ephemeral home directory with selective mounts
   # Create a temporary home that's cleaned up after sandbox exits
   local sandbox_home
   sandbox_home=$(mktemp -d)
   trap "rm -rf '$sandbox_home'" EXIT

   # Mount ephemeral home as HOME
   bwrap_args+=(--bind "$sandbox_home" "${HOME}")

   # Mount host directories over the ephemeral home
   # .config - read-only configuration
   if [[ -d "${HOME}/.config" ]]; then
     mkdir -p "$sandbox_home/.config"
     bwrap_args+=(--ro-bind "/${HOME#/}/.config" "${HOME}/.config")
   fi

   # .local/share/opencode - read-write opencode data
   if [[ -d "${HOME}/.local/share/opencode" ]]; then
     mkdir -p "$sandbox_home/.local/share/opencode"
     bwrap_args+=(--bind "/${HOME#/}/.local/share/opencode" "${HOME}/.local/share/opencode")
   fi

   # .local/state/opencode - read-write opencode state
   if [[ -d "${HOME}/.local/state/opencode" ]]; then
     mkdir -p "$sandbox_home/.local/state/opencode"
     bwrap_args+=(--bind "/${HOME#/}/.local/state/opencode" "${HOME}/.local/state/opencode")
   fi

   # .cache/opencode - read-write cache (models, node_modules for faster startup)
   if [[ -d "${HOME}/.cache/opencode" ]]; then
     mkdir -p "$sandbox_home/.cache/opencode"
     bwrap_args+=(--bind "/${HOME#/}/.cache/opencode" "${HOME}/.cache/opencode")
   fi

   # .nix-profile - read-only installed packages
   if [[ -e "${HOME}/.nix-profile" ]]; then
     bwrap_args+=(--ro-bind "/${HOME#/}/.nix-profile" "${HOME}/.nix-profile")
   fi

   # Work directory - mounted at same path for convenience
   local cwd
   cwd=$(pwd)
   bwrap_args+=(--bind "$cwd" "$cwd")

   # dbus socket access for notifications
   bwrap_args+=(--ro-bind /run/user/$UID /run/user/$UID)

   # System profile for tools (nix, etc.)
   bwrap_args+=(--ro-bind /run/current-system /run/current-system)

  # Isolated temporary storage
  bwrap_args+=(--tmpfs /tmp)

  # DNS resolution
  bwrap_args+=(--ro-bind /etc/resolv.conf /etc/resolv.conf)

  # SSL/TLS certificates for HTTPS
  bwrap_args+=(--ro-bind /etc/ssl /etc/ssl)
  if [[ -d /etc/static/ssl ]]; then
    bwrap_args+=(--ro-bind /etc/static/ssl /etc/static/ssl)
  fi

  # Optional: Network isolation
  if [[ $DISABLE_NET -eq 1 ]]; then
    bwrap_args+=(--unshare-net)
  fi

  # Custom bind mounts (read-write)
  for bind in "${EXTRA_BINDS[@]}"; do
    local src="${bind%:*}"
    local dst="${bind#*:}"
    [[ -z "$src" || -z "$dst" ]] && error "Invalid bind format: $bind (use SRC:DST)"
    bwrap_args+=(--bind "$src" "$dst")
  done

  # Custom bind mounts (read-only)
  for bind in "${EXTRA_RO_BINDS[@]}"; do
    local src="${bind%:*}"
    local dst="${bind#*:}"
    [[ -z "$src" || -z "$dst" ]] && error "Invalid bind format: $bind (use SRC:DST)"
    bwrap_args+=(--ro-bind "$src" "$dst")
  done

   # Pass all environment variables from host
   bwrap_args+=(--clearenv)
   while IFS='=' read -r key val; do
     [[ -z "$key" ]] && continue
     bwrap_args+=(--setenv "$key" "$val")
   done < <(env)

   # Set OPENCODE_YOLO environment variable if yolo mode is enabled
   if [[ $YOLO_MODE -eq 1 ]]; then
     bwrap_args+=(--setenv OPENCODE_YOLO "1")
   fi

    # Default to launching opencode in interactive zsh shell if no command given
    if [[ ${#COMMAND_ARGS[@]} -eq 0 ]]; then
      # If we have opencode args but no command, launch opencode with those args
      if [[ ${#OPENCODE_ARGS[@]} -gt 0 ]]; then
        COMMAND_ARGS=("opencode" "${OPENCODE_ARGS[@]}")
      else
        COMMAND_ARGS=("${SHELL:-/bin/bash}" -i -c "exec opencode")
      fi
    elif [[ ${#OPENCODE_ARGS[@]} -gt 0 ]]; then
      # If we have both command and opencode args, append opencode args to command
      COMMAND_ARGS+=("${OPENCODE_ARGS[@]}")
    fi

  # Invoke bubblewrap with the sandbox configuration
  @bubblewrap@/bin/bwrap "${bwrap_args[@]}" "${COMMAND_ARGS[@]}"
}

##############################################################################
# Main Entry Point
##############################################################################

main() {
  parse_args "$@"
  run_sandbox
}

main "$@"
