# Grafana Dashboard Troubleshooting and Code Migration

## Summary
Investigated and fixed the OPNsense & IDS/IPS -2 Grafana dashboard, identified panel issues, and migrated the dashboard to infrastructure-as-code in the nix-config repository.

## Issues Found and Fixed

### 1. Potential Attacks from (Geomap Panel ID 35)
**Problem:** No datapoints displayed despite query returning latitude/longitude/value data
**Root Cause:** Incomplete geomap location configuration - missing the `lookup` field
**Solution:** Updated location config from `{"mode": "lookup"}` to `{"lookup": "hits", "mode": "auto"}`

### 2. Blocked by IDS/IPS Rules (Panel ID 2)
**Problem:** Panel needed proper filtering on dropped Suricata traffic
**Solution:** Updated query to: `{job="syslog-ids",host="$host"} event_type:"alert" | alert.action:~"drop|blocked"`

### 3. Other IDS related Logs (Panel ID 3)
**Problem:** Unclear what logs to show besides alerts
**Solution:** Updated query to show all non-alert events: `{job="syslog-ids",host="$host"} | !event_type:"alert"`

## Implementation Steps

### Moved dashboard to nix-config
1. Downloaded dashboard JSON from Grafana UI: `OPNsense & IDS_IPS -2-1767292627005.json`
2. Moved to: `hosts/modules/linux/shared/grafana/dashboards/opnsense-ids2.json`
3. Added dashboard config to `hosts/modules/linux/shared/grafana/default.nix`

### Updated Nix Configuration
1. Added `opnsense-ids2` entry to `dashboardConfigs` with:
   - Local path reference: `path = ./dashboards/opnsense-ids2.json;`
   - Datasource mapping transformations for VictoriaLogs
2. Enhanced `mkDashboardProvider` function to support local file paths in addition to remote sources

### File Changes
- **Modified:** `/home/vince/projects/nix-config/hosts/modules/linux/shared/grafana/default.nix`
- **Added:** `/home/vince/projects/nix-config/hosts/modules/linux/shared/grafana/dashboards/opnsense-ids2.json`

## Technical Details

### Suricata EVE Log Fields
- **Best field for drop filtering:** `alert.action` (values: "drop", "blocked", "allowed")
- **Event type filtering:** `event_type` field (values: "alert", "flow", "dns", "http", "tls", etc.)

### VictoriaLogs Query Syntax
- Use `|` (pipe) for chaining filters, not `AND`/`OR`
- Use `:~` for regex matching (e.g., `alert.action:~"drop|blocked"`)
- Use `:!=` for negation (e.g., `event_type:!="alert"`)

### Nix Dashboard Management
The updated configuration now supports three ways to provision dashboards:
1. From grafana.com (via ID): `id = 22248; version = 1; sha256 = "..."`
2. From remote URL: `url = "https://..."; sha256 = "..."`
3. From local file: `path = ./dashboards/opnsense-ids2.json;`

## Next Steps
Deploy changes using: `nix flake update && make host/apply`
