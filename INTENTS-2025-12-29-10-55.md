# Fix OPNsense Grafana Processes Panel - Show Rate Instead of Cumulative Data

**Date:** 2025-12-29 (continued from Uptime panel fix)  
**Problem:** Processes panel showed cumulative counters since boot, not current activity

## Analysis of Original Issue

**Panel Configuration:**
- Type: Bar Gauge
- Metrics: `node_exec_forks_total`, `node_exec_system_calls_total`, `node_exec_traps_total`
- Reducer: `lastNotNull` (shows last value)

**Why It Was Wrong:**
- ❌ Shows total forks/calls since system boot (not activity)
- ❌ Value only increases, doesn't reflect current load
- ❌ Bar gauge with color thresholds (green/orange/red) are misleading without a meaningful max
- ❌ Not useful for firewall/gateway monitoring
- ❌ Can't distinguish idle periods from busy periods

**What a High Value Means:** "System has been running for a long time"  
**What We Actually Want:** "How many process events per second is happening now?"

## Solution Implemented

Created a new transformation function `fixProcessesPanel` in the Grafana library that:

1. **Changes metric type** from counter totals to rate (events per second)
2. **Updates all three queries** to use `rate()` function with 1-minute window
3. **Changes visualization** from Bar Gauge to Time Series
4. **Updates legend** to show "Forks/sec", "System Calls/sec", "Traps/sec"

### Changes Made

#### 1. Added `fixProcessesPanel` Function to `hosts/modules/linux/shared/grafana/lib/default.nix`

```nix
fixProcessesPanel = dashboard:
  let
    updateTarget = target:
      if target.refId == "A" then
        target // {
          expr = "rate(node_exec_forks_total{job=\"$scrape_jobs\"}[1m])";
          legendFormat = "Forks/sec";
        }
      else if target.refId == "B" then
        target // {
          expr = "rate(node_exec_system_calls_total{job=\"$scrape_jobs\"}[1m])";
          legendFormat = "System Calls/sec";
        }
      else if target.refId == "C" then
        target // {
          expr = "rate(node_exec_traps_total{job=\"$scrape_jobs\"}[1m])";
          legendFormat = "Traps/sec";
        }
      else
        target;
    updatePanel = panel:
      if panel.id == 10 && panel.title == "Processes"
      then panel // {
        type = "timeseries";
        targets = map updateTarget panel.targets;
        options = panel.options // {
          legend = {
            calcs = [];
            displayMode = "list";
            placement = "bottom";
            showLegend = true;
          };
          tooltip = {
            mode = "multi";
            sort = "none";
          };
        };
      }
      else
        panel;
  in
  dashboard // {
    panels = map updatePanel dashboard.panels;
  };
```

#### 2. Updated OPNsense Dashboard Config in `hosts/modules/linux/shared/grafana/default.nix`

Added `dashLib.fixProcessesPanel` to the transformation pipeline:

```nix
opnsense = {
  id = 22248;
  version = 1;
  sha256 = "sha256:1sy6k1bcprldgnzq8z86c5ilv4pb2yiz0jn7xpma2rcfvpkaw9al";
  transform = dashboard:
    lib.pipe dashboard [
      (dashLib.setUid "opnsense")
      (dashLib.replaceDatasources [
        {
          key = "DS_PROMETHEUS";
          value = "Prometheus";
        }
      ])
      dashLib.removeTimeOverrides
      dashLib.fixProcessesPanel  # ← NEW
    ];
};
```

## Verification

✅ Transformation tested and verified:
```
Input panel type:  "bargauge"
Output panel type: "timeseries"

Input query A:  "node_exec_forks_total{job="$scrape_jobs"}"
Output query A: "rate(node_exec_forks_total{job="$scrape_jobs"}[1m])"

Input query B:  "node_exec_system_calls_total{job="$scrape_jobs"}"
Output query B: "rate(node_exec_system_calls_total{job="$scrape_jobs"}[1m])"

Input query C:  "node_exec_traps_total{job="$scrape_jobs"}"
Output query C: "rate(node_exec_traps_total{job="$scrape_jobs"}[1m])"
```

✅ Configuration built successfully

## Impact

**Benefits:**
- ✅ Panel now shows **actual current activity** (events/sec) not cumulative totals
- ✅ Time series visualization shows **trends over time**
- ✅ Useful for correlating with network activity
- ✅ Meaningful for firewall/gateway monitoring
- ✅ Helps identify system load patterns

**Visualization Changes:**
- Before: Bar gauge showing static percentage (confusing)
- After: Time series line chart showing events per second (intuitive)

**Data Interpretation:**
- Before: "9000000 forks total" (meaningless without boot time)
- After: "500 forks/sec, 10000 syscalls/sec, 200 traps/sec" (immediately actionable)

## Next Steps

1. Apply changes: `make host/apply`
2. Verify Processes panel now shows rate-based metrics with time series visualization
3. Monitor panel for expected behavior (should show activity spikes correlating with network traffic)

## Related Changes

- **Uptime Panel:** Fixed with `removeTimeOverrides` in previous change
- **Other Panels:** Consider applying rate() transformation to other cumulative metrics (Interrupts panel also uses counters)
