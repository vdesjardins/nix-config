# Fix OPNsense Grafana Dashboard Race Condition

**Date:** 2025-12-29 10:46  
**Problem:** Uptime panel (ID: 1) intermittently displays "N/A" instead of valid uptime values at refresh time

## Root Cause Analysis

The Uptime panel had a timing mismatch that created a race condition:

- **Scrape Interval:** 15 seconds (from `victoriametrics.nix`)
- **Panel Time Window:** 10 seconds (`timeFrom: "10s"`)
- **Issue:** 10s < 15s → Panel sometimes queries when no recent data exists in the window

When Grafana refreshed the panel:
- ✅ Success: Queries within 5 seconds after a scrape completes (data available)
- ❌ Failure: Queries in the ~10-second gap when the lookback window contains no recent data points

VictoriaMetrics always returned results because direct queries used much wider time ranges.

## Solution Implemented

Created a generic Nix transformation function `removeTimeOverrides` that:

1. **Removes problematic time constraints** from all dashboard panels
2. **Lets panels use the dashboard's time range** (now-1h) instead of a fixed 10-second window
3. **Eliminates the race condition entirely** while maintaining panel functionality

### Changes Made

#### 1. Added Helper Function to `hosts/modules/linux/shared/grafana/lib/default.nix`

```nix
# Removes time override constraints (timeFrom, hideTimeOverride) from all panels.
# This ensures panels use the dashboard's time range instead of a fixed window,
# preventing race conditions when the fixed window is smaller than the scrape interval.
removeTimeOverrides = dashboard: dashboard // {
  panels = map (panel: panel // {
    timeFrom = null;
    hideTimeOverride = null;
  }) dashboard.panels;
};
```

#### 2. Updated `hosts/modules/linux/shared/grafana/default.nix`

Added `dashLib.removeTimeOverrides` to the OPNsense dashboard transformation pipeline:

```nix
opnsense = {
  id = 22248;
  version = 1;
  sha256 = "sha256:1sy6k1bcprldgnzq8z86c5ilv4pb2yiz0jn7xpma2rcfvpkaw9al";
  transform = dashboard:
    lib.pipe dashboard [
      (dashLib.setUid "opnsense")
      (dashLib.replaceDatasources [
        {
          key = "DS_PROMETHEUS";
          value = "Prometheus";
        }
      ])
      dashLib.removeTimeOverrides  # <-- NEW: Removes time overrides
    ];
};
```

## Verification

✅ Nix flake check passed
✅ Host configuration built successfully (nix build .#nixosConfigurations.falcon.config.system.build.toplevel)
✅ Transformation tested and verified:
- Input: `{ panels = [{ id = 1; timeFrom = "10s"; hideTimeOverride = true; }, ...] }`
- Output: `{ panels = [{ id = 1; timeFrom = null; hideTimeOverride = null; }, ...] }`

## Impact

**Benefits:**
- ✅ Eliminates intermittent "N/A" results in Uptime panel
- ✅ Removes all time override constraints from dashboard (Temperature panel already fixed separately)
- ✅ Uses dashboard's stable time range (now-1h) for all panels
- ✅ Generic function can be reused for other dashboards

**Risk Level:** Very Low
- Provisioned dashboard still manages all panels
- Only removes unnecessary time constraints
- Dashboard will use standard time range controls

## Next Steps

1. Apply changes: `make host/apply`
2. Verify Uptime panel consistently shows valid values at each refresh
3. Monitor for any unexpected behavior in other panels

## Related Issues

- **Temperature Panel:** Already fixed by removing `timeFrom` override (no changes needed)
- **Other Dashboards:** Consider applying the same transformation to opnsense-ids, cadvisor, victoriametrics, and victorialogs if they have similar issues
